<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Corrida do Ovo na Colher</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    
    <!-- Script de controle ANTES da cena -->
    <script>
        // Componente para objetos que podem ser pegos
        AFRAME.registerComponent('grabbable', {
            init: function() {
                this.el.addEventListener('click', (evt) => {
                    console.log('Clicou no objeto:', this.el.id); // Debug
                    
                    if (this.el.id === 'colher' && !window.hasSpoon) {
                        window.hasSpoon = true;
                        document.querySelector('#instructions').setAttribute('value', 'Agora pegue o ovo!');
                        document.querySelector('#ovo').setAttribute('visible', 'true');
                        
                        // Remove física e animação
                        this.el.removeAttribute('dynamic-body');
                        this.el.removeAttribute('animation');
                        
                        // Anexa à mão do jogador
                        this.el.setAttribute('position', '0 0 0');
                        document.querySelector('#hand').appendChild(this.el);
                        
                        console.log('Colher pega!'); // Debug
                    } 
                    else if (this.el.id === 'ovo' && window.hasSpoon && !window.hasEgg) {
                        window.hasEgg = true;
                        document.querySelector('#instructions').setAttribute('value', 'Agora corra! Clique para começar.');
                        
                        // Remove física
                        this.el.removeAttribute('dynamic-body');
                        
                        // Anexa à mão do jogador (sobre a colher)
                        this.el.setAttribute('position', '0 0.05 0');
                        document.querySelector('#hand').appendChild(this.el);
                        
                        console.log('Ovo pego!'); // Debug
                    }
                    else if (window.hasSpoon && window.hasEgg && !window.isRunning) {
                        startRunning();
                    }
                });
            }
        });

        // Variáveis de estado globais
        window.hasSpoon = false;
        window.hasEgg = false;
        window.isRunning = false;

        // Função para começar a correr
        function startRunning() {
            window.isRunning = true;
            document.querySelector('#instructions').setAttribute('value', 'Correndo...');
            
            // Move a colher com o ovo para a "boca"
            const spoon = document.querySelector('#colher');
            const egg = document.querySelector('#ovo');
            
            document.querySelector('#mouth').appendChild(spoon);
            document.querySelector('#mouth').appendChild(egg);
            
            // Ajusta posições
            spoon.setAttribute('position', '0 0 -0.3');
            spoon.setAttribute('rotation', '0 0 10');
            egg.setAttribute('position', '0 0.1 -0.2');
            
            // Adiciona animação de corrida
            document.querySelector('#camera').setAttribute('animation', {
                property: 'position',
                to: '0 1.6 -20',
                dur: 10000,
                easing: 'linear'
            });
            
            console.log('Começou a correr!'); // Debug
        }
    </script>



    <script>
        AFRAME.registerComponent('check-finish', {
            tick: function () {
                const player = document.querySelector('#player');
                const finish = document.querySelector('#finish-line');
                
                const pPos = player.object3D.position;
                const fPos = finish.object3D.position;
                
                // Distância até a linha de chegada
                const dist = pPos.distanceTo(fPos);
                
                if (dist < 2 && !window.finished) {
                    window.finished = true;
                    
                    const msg = document.querySelector('#victory-message');
                    msg.setAttribute('visible', 'true');
                }
            }
        });
    </script>

<script>
    AFRAME.registerComponent('win-condition', {
      schema: {
        finish: { type: 'selector' },
        message: { type: 'selector' },
        confetti: { type: 'selector' }
      },
    
      tick: function () {
        if (this.hasWon) return;
    
        const player = document.querySelector('#player');
        const finish = this.data.finish;
    
        if (!player || !finish) return;
    
        const pPos = player.object3D.position;
        const fPos = finish.object3D.position;
    
        const dist = pPos.distanceTo(fPos);
    
        if (dist < 2) {
          this.hasWon = true;
    
          if (this.data.message) {
            document.querySelector('#victory-panel').setAttribute('visible', true);
          }
    
          if (this.data.confetti) {
            this.data.confetti.setAttribute('visible', true);
            this.startConfettiAnimation(this.data.confetti);
          }
        }
      },
    
      startConfettiAnimation: function (container) {
        const confettis = container.querySelectorAll('.confetti');

        confettis.forEach(confetti => {
            const randomX = (Math.random() - 0.5) * 4;
            const randomZ = (Math.random() - 0.5) * 4;
            const startY = 0;
            const endY = -3; // cair para baixo
            const duration = Math.random() * 1000 + 2000;

            confetti.setAttribute('animation__pos', {
            property: 'position',
            from: `${randomX} ${startY} ${randomZ}`,
            to: `${randomX} ${endY} ${randomZ}`,
            dur: duration,
            easing: 'easeInQuad'
            });
            confetti.setAttribute('animation__rot', {
            property: 'rotation',
            to: `360 360 360`,
            dur: 1000,
            loop: true
            });
        });
        }
        
    });
    </script>

    <script>
        const musicPlayer = document.querySelector('#music-player');
        window.addEventListener('click', () => {
            musicPlayer.components.sound.playSound();
        });
    </script>
    
</head>
<body>
    <a-scene physics="debug: true" cursor="rayOrigin: mouse">
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="colher-obj" src="./Assets/objetos/colher.glb"></a-asset-item>
            <a-asset-item id="ovo-obj" src="./Assets/objetos/ovo.glb"></a-asset-item>
            <audio id="winning" src="./Assets/sons/winning.mp3"></audio>
            <audio id="baby-music" src="./Assets/sons/baby-music.mp3"></audio>
        </a-assets>

        <!-- Ambiente -->
        <a-entity environment="preset: forest"></a-entity>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#7BC8A4" static-body></a-plane>
        
        <!-- Sons -->
        <a-entity sound="src: #winning; autoplay: true"></a-entity>
        <a-entity sound="src: #baby-music; autoplay: true"></a-entity>

        <!-- Objetos interativos -->        
        <!-- Estrada -->
        <a-box id="road"
            position="0 0.01 -10"
            width="4"
            height="0.05"
            depth="20"
            color="#555555"
            static-body>
        </a-box>

        <!-- Faixa central da estrada -->
        <a-box id="road-line"
            position="0 0.02 -10"
            width="0.1"
            height="0.051"
            depth="20"
            color="#ffffff"
            static-body>
        </a-box>

        <!-- Linha de chegada -->
        <a-box id="finish-line"
            position="0 0.03 -20"
            width="4"
            height="0.051"
            depth="0.5"
            color="white"
            static-body>
        </a-box>

        <!-- Contêiner que o jogador controla -->
        <a-entity id="player" position="0 1.6 0" wasd-controls look-controls>
            <!-- Mão do jogador -->
            <a-entity id="hand" position="0.2 -0.3 -0.5">
                <!-- Colher (inicialmente solta) -->
                <a-entity id="colher" 
                        gltf-model="#colher-obj"
                        position="-0.2 0 0"
                        scale="3 3 3"
                        grabbable
                        dynamic-body="mass: 0.5">
                    <a-animation attribute="rotation"
                                dur="2000"
                                to="0 360 0"
                                repeat="indefinite"></a-animation>
                </a-entity>
            </a-entity>
            <!-- Ovo (fica na colher depois de pegar) -->
            <a-entity id="ovo" 
                    gltf-model="#ovo-obj"
                    position="0 -0.15 -0.4"
                    scale="4 4 4"
                    grabbable
                    dynamic-body="mass: 0.3"
                    visible="true">
            </a-entity>
            <a-camera>
                <a-entity id="mouth" position="0 -0.2 -0.5"></a-entity>
            </a-camera>
        </a-entity>

        <!-- Ativa detecção de chegada com confetes -->
        <a-entity win-condition="finish: #finish-line; message: #victory-message; confetti: #confetti-container"></a-entity>

        <!-- Arco de chegada -->
        <a-entity id="finish-arch" position="0 2 -20">
            <a-box position="0 2 0" width="4" height="0.1" depth="0.1" color="black"></a-box>
            <a-box position="-2 -1 0" width="0.1" height="6" depth="0.1" color="#ff0000"></a-box>
            <a-box position="2 -1 0" width="0.1" height="6" depth="0.1" color="#ff0000"></a-box>
        </a-entity>

        <!-- Texto -->
        <a-entity id="ui" position="0 0 -0.5">
            <a-text id="instructions" value="Pegue a Colher Primeiro!" 
                   align="center" width="5" position="0 3.5 -4" color="black"></a-text>
        </a-entity>

        <!-- Mão do jogador -->
        <a-entity id="hand" position="0.2 -0.3 -0.5"></a-entity>

        <!-- Câmera -->
        <a-camera id="camera">
            <a-entity id="mouth" position="0 -0.2 -0.5"></a-entity>
        </a-camera>

       <!-- Container de confetes -->
        <a-entity id="confetti-container" visible="false" position="0 4 -22">
        <!-- Gerar vários confetes coloridos -->
        <a-plane class="confetti" color="#ff0000" depth="0.05" height="0.05" width="0.05" position="0 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#00ff00" depth="0.05" height="0.05" width="0.05" position="1 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#0000ff" depth="0.05" height="0.05" width="0.05" position="-1 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ffff00" depth="0.05" height="0.05" width="0.05" position="0.5 0.5 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ff00ff" depth="0.05" height="0.05" width="0.05" position="-0.5 0.5 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ff0000" depth="0.05" height="0.05" width="0.05" position="0 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#00ff00" depth="0.05" height="0.05" width="0.05" position="1 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#0000ff" depth="0.05" height="0.05" width="0.05" position="-1 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ffff00" depth="0.05" height="0.05" width="0.05" position="0.5 0.5 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ff00ff" depth="0.05" height="0.05" width="0.05" position="-0.5 0.5 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ff0000" depth="0.05" height="0.05" width="0.05" position="0 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#00ff00" depth="0.05" height="0.05" width="0.05" position="1 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#0000ff" depth="0.05" height="0.05" width="0.05" position="-1 0 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ffff00" depth="0.05" height="0.05" width="0.05" position="0.5 0.5 0" material="side:double"></a-plane>
        <a-plane class="confetti" color="#ff00ff" depth="0.05" height="0.05" width="0.05" position="-0.5 0.5 0" material="side:double"></a-plane>
        </a-entity>
        <!-- Texto de vitória (HUD) com fundo -->
        <a-entity id="victory-panel" position="0 3.5 -26" visible="false">
        <!-- Fundo do painel -->
        <a-plane width="4" height="1" color="#222" opacity="0.8" material="side: double" position="0 0 0"></a-plane>
        
        <!-- Borda decorativa -->
        <a-plane width="4.1" height="1.1" color="#FFD700" opacity="0.9" position="0 0 -0.01"></a-plane>
        
        <!-- Texto -->
        <a-text id="victory-message" 
                value="PARABENS! VOCE VENCEU!"
                align="center" 
                width="5" 
                color="#FFD700" 
                position="0 0 0.01"
                font="mozillavr">
        </a-text>
        </a-entity>
  </a-entity>
    </a-scene>
</body>
</html>